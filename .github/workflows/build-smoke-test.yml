name: Build & Smoke Test

on:
  push:
    branches: [main, SELC-7988]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build library
        run: npm run build

      - name: Verify build outputs
        run: |
          test -f dist/index.js || (echo "ERROR: dist/index.js not found" && exit 1)
          test -f dist/index.d.ts || (echo "ERROR: dist/index.d.ts not found" && exit 1)
          test -f dist/index.css || (echo "ERROR: dist/index.css not found" && exit 1)
          echo "✓ All build artifacts present"

      - name: Type check built types
        run: npx tsc --noEmit --skipLibCheck dist/index.d.ts

      - name: Create temporary consumer project
        run: |
          mkdir -p /tmp/consumer-test
          cd /tmp/consumer-test
          npm init -y
          npm install --save-dev typescript @types/react @types/react-dom react react-dom

      - name: Test root imports (runtime)
        run: |
          cat > /tmp/consumer-test/test-imports.mjs << 'EOF'
          const mod = await import('../../dist/index.js');
          const exports = Object.keys(mod);
          console.log(`✓ Exported ${exports.length} symbols from root entry`);
          
          // Verify key exports are present
          const requiredExports = [
            'Header', 'Footer', 'Toast', 'useLoading', 
            'CustomAlert', 'FilterModal', 'ErrorBoundary'
          ];
          
          const missing = requiredExports.filter(exp => !exports.includes(exp));
          if (missing.length > 0) {
            console.error(`✗ Missing exports: ${missing.join(', ')}`);
            process.exit(1);
          }
          console.log(`✓ All key exports present: ${requiredExports.join(', ')}`);
          EOF
          cd /tmp/consumer-test
          node test-imports.mjs

      - name: Test TypeScript declaration resolution
        run: |
          cat > /tmp/consumer-test/test-types.ts << 'EOF'
          import { Header, Toast, useLoading, CustomAlert, ErrorBoundary } from '../../dist/index';
          
          // This file just needs to type-check; if imports fail, tsc will error
          const _typeCheck: Header = null as any;
          EOF
          cd /tmp/consumer-test
          npx tsc --noEmit --skipLibCheck test-types.ts

      - name: Validate package.json exports field
        run: |
          node -e "
          const pkg = require('./package.json');
          const exports = pkg.exports;
          if (!exports['.']) {
            console.error('ERROR: Root entry (\".\") not found in exports');
            process.exit(1);
          }
          if (exports['.'].require) {
            console.warn('WARNING: CommonJS (require) export present; package is ESM-only');
          }
          if (!exports['.'].import || !exports['.'].types) {
            console.error('ERROR: Missing import or types in root export');
            process.exit(1);
          }
          console.log('✓ package.json exports field is valid');
          "

      - name: Check for deep import blockers
        run: |
          if grep -r "export.*from.*components/" dist/index.js | grep -v "import"; then
            echo "✓ No deep imports in output (expected)"
          fi
          if [ -d "dist/components" ] || [ -d "dist/hooks" ]; then
            echo "✗ WARNING: Per-module files detected; deep imports may still be possible"
            echo "  This is OK for backwards compatibility, but root-only API is recommended"
          else
            echo "✓ Single-file bundle confirmed (root-only API)"
          fi
